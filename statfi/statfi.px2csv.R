
# CSV conversion
# Create file/folder structure similar to the original

#source("statfi_20120922.R")

setwd("/home/lei/Rpackages/louhos/takomo/statfi")
load("StatFi_px_urls.RData") # px.tree
#load("StatFi_px_urls_20120505.RData") # px.tree


filesalreadyhandled <- NULL; i <- 0; save(filesalreadyhandled, i, file = "tmp.RData")

#files.already.handled <- c()

message("Changing folder to StatFin where the data will be saved!")
setwd("StatFin")

load("tmp.RData")

library(pxR)
#source("../read.pxr.fix.R") # Fix read.px function

# Manual test
tmp <- read.px("http://pxweb2.stat.fi/database/StatFin/hin/pthi/004_pthi_tau_004_fi.px")

stop("OK")


pxf.errors <- c()
bad.px.files <- c("http://pxweb2.stat.fi/database/StatFin/asu/asas/020_asas_tau_102_fi.px", "http://pxweb2.stat.fi/database/StatFin/asu/asas/030_asas_tau_103_fi.px", "http://pxweb2.stat.fi/database/StatFin/asu/ashi/003_ashi_tau_108.px", "http://pxweb2.stat.fi/database/StatFin/asu/ashi/004_ashi_tau_109_fi.px",  "http://pxweb2.stat.fi/database/StatFin/hin/khi/010_khi_tau_101_fi.px", "http://pxweb2.stat.fi/database/StatFin/hin/thi/009_thi_tau_009_fi.px", "http://pxweb2.stat.fi/database/StatFin/hin/thi/010_thi_tau_101_fi.px", "http://pxweb2.stat.fi/database/StatFin/hin/thi/020_thi_tau_102_fi.px", "http://pxweb2.stat.fi/database/StatFin/hin/thi/030_thi_tau_103_fi.px", "http://pxweb2.stat.fi/database/StatFin/kan/altp/020_altp_tau_102_fi.px", "http://pxweb2.stat.fi/database/StatFin/kan/altp/040_altp_tau_104_fi.px", "http://pxweb2.stat.fi/database/StatFin/kan/altp/060_altp_tau_106_fi.px", "http://pxweb2.stat.fi/database/StatFin/kan/vtp/070_vtp_tau_070.px", "http://pxweb2.stat.fi/database/StatFin/kan/vtp/080_vtp_tau_080.px", "http://pxweb2.stat.fi/database/StatFin/kan/vtp/180_vtp_tau_180.px", "http://pxweb2.stat.fi/database/StatFin/kan/vtp/190_vtp_tau_190.px", "http://pxweb2.stat.fi/database/StatFin/kan/rtp/010_rtp_tau_101_fi.px", "http://pxweb2.stat.fi/database/StatFin/kou/aop/030_aop_tau_103_fi.px", "http://pxweb2.stat.fi/database/StatFin/kou/aop/040_aop_tau_104_fi.px", "http://pxweb2.stat.fi/database/StatFin/kou/aop/040_aop_tau_104_fi.px", "http://pxweb2.stat.fi/database/StatFin/kou/aop/049_aop_tau_106_fi.px", "http://pxweb2.stat.fi/database/StatFin/kou/aop/050_aop_tau_105_fi.px", "http://pxweb2.stat.fi/database/StatFin/kou/akop/380_akop_tau_112_fi.px", "http://pxweb2.stat.fi/database/StatFin/kou/akop/410_akop_tau_110_fi.px", "http://pxweb2.stat.fi/database/StatFin/kou/akop/420_akop_tau_108_fi.px", "http://pxweb2.stat.fi/database/StatFin/kou/akop/490_akop_tau_103_fi.px", "http://pxweb2.stat.fi/database/StatFin/kou/akop/500_akop_tau_101_fi.px", "http://pxweb2.stat.fi/database/StatFin/kou/pop/050_pop_tau_105_fi.px", "http://pxweb2.stat.fi/database/StatFin/kou/pop/060_pop_tau_106_fi.px", "http://pxweb2.stat.fi/database/StatFin/kou/pop/080_pop_tau_108_fi.px", "http://pxweb2.stat.fi/database/StatFin/kou/pop/110_pop_tau_101_fi.px", "http://pxweb2.stat.fi/database/StatFin/kou/pop/120_pop_tau_102_fi.px", "http://pxweb2.stat.fi/database/StatFin/kou/pop/130_pop_tau_103_fi.px", "http://pxweb2.stat.fi/database/StatFin/kou/pop/140_pop_tau_104_fi.px", "http://pxweb2.stat.fi/database/StatFin/kou/kjarj/010_kjarj_tau_101_fi.px", "http://pxweb2.stat.fi/database/StatFin/kou/opiskt/020_opiskt_tau_111_fi.px", "http://pxweb2.stat.fi/database/StatFin/kou/opiskt/030_opiskt_tau_112_fi.px", "http://pxweb2.stat.fi/database/StatFin/kou/opiskt/200_opiskt_tau_101_fi.px", "http://pxweb2.stat.fi/database/StatFin/kou/opiskt/210_opiskt_tau_101_fi.px", "http://pxweb2.stat.fi/database/StatFin/kou/opiskt/220_opiskt_tau_105_fi.px", "http://pxweb2.stat.fi/database/StatFin/kou/opiskt/260_opiskt_tau_102_fi.px", "http://pxweb2.stat.fi/database/StatFin/kou/opiskt/300_opiskt_tau_110_fi.px", "http://pxweb2.stat.fi/database/StatFin/kou/opiskt/310_opiskt_tau_120_fi.px", "http://pxweb2.stat.fi/database/StatFin/lii/matk/020_matk_tau_102_fi.px", "http://pxweb2.stat.fi/database/StatFin/lii/matk/040_matk_tau_104_fi.px", "http://pxweb2.stat.fi/database/StatFin/maa/mmtal/020_mmtal_tau_102_fi.px", "http://pxweb2.stat.fi/database/StatFin/oik/hovoikr/005_hovoikr_tau_102_fi.px", "http://pxweb2.stat.fi/database/StatFin/oik/hovoikr/010_hovoikr_tau_101_fi.px", "http://pxweb2.stat.fi/database/StatFin/oik/julo/010_julo_tau_101_fi.px", "http://pxweb2.stat.fi/database/StatFin/oik/konk/010_konk_tau_101_fi.px", "http://pxweb2.stat.fi/database/StatFin/oik/konk/020_konk_tau_102_fi.px", "http://pxweb2.stat.fi/database/StatFin/oik/khaloikr/010_khaloikr_tau_101_fi.px", "http://pxweb2.stat.fi/database/StatFin/oik/koikrr/005_koikrr_tau_102_fi.px", "http://pxweb2.stat.fi/database/StatFin/oik/koikrr/010_koikrr_tau_101_fi.px", "http://pxweb2.stat.fi/database/StatFin/oik/koikrs/005_koikrs_tau_103_fi.px", "http://pxweb2.stat.fi/database/StatFin/oik/koikrs/006_koikrs_tau_104_fi.px", "http://pxweb2.stat.fi/database/StatFin/oik/koikrs/010_koikrs_tau_101_fi.px", "http://pxweb2.stat.fi/database/StatFin/oik/koikrs/020_koikrs_tau_102_fi.px", "http://pxweb2.stat.fi/database/StatFin/oik/pkei/015_pkei_tau_107_fi.px", "http://pxweb2.stat.fi/database/StatFin/oik/pkei/020_pkei_tau_102_fi.px", "http://pxweb2.stat.fi/database/StatFin/oik/pkei/025_pkei_tau_106_fi.px", "http://pxweb2.stat.fi/database/StatFin/oik/pkei/030_pkei_tau_105_fi.px", "http://pxweb2.stat.fi/database/StatFin/oik/pkei/040_pkei_tau_103_fi.px", "http://pxweb2.stat.fi/database/StatFin/oik/pkei/050_pkei_tau_104_fi.px", "http://pxweb2.stat.fi/database/StatFin/oik/polrik/002_polrik_tau_111_fi.px", "http://pxweb2.stat.fi/database/StatFin/oik/polrik/003_polrik_tau_109_fi.px", "http://pxweb2.stat.fi/database/StatFin/oik/polrik/004_polrik_tau_108_fi.px", "http://pxweb2.stat.fi/database/StatFin/oik/polrik/005_polrik_tau_103_fi.px", "http://pxweb2.stat.fi/database/StatFin/oik/polrik/010_polrik_tau_101_fi.px", "http://pxweb2.stat.fi/database/StatFin/oik/polrik/050_polrik_tau_105_fi.px", "http://pxweb2.stat.fi/database/StatFin/oik/polrik/060_polrik_tau_106_fi.px", "http://pxweb2.stat.fi/database/StatFin/oik/polrik/080_polrik_tau_108_fi.px", "http://pxweb2.stat.fi/database/StatFin/oik/polrik/090_polrik_tau_109_fi.px", "http://pxweb2.stat.fi/database/StatFin/oik/syyttr/010_syyttr_tau_109_fi.px", "http://pxweb2.stat.fi/database/StatFin/oik/syyttr/020_syyttr_tau_101_fi.px", "http://pxweb2.stat.fi/database/StatFin/oik/syyttr/040_syyttr_tau_102_fi.px", "http://pxweb2.stat.fi/database/StatFin/oik/syyttr/044_syyttr_tau_110_fi.px", "http://pxweb2.stat.fi/database/StatFin/oik/syyttr/045_syyttr_tau_108_fi.px", "http://pxweb2.stat.fi/database/StatFin/oik/syyttr/046_syyttr_tau_111_fi.px", "http://pxweb2.stat.fi/database/StatFin/oik/syyttr/050_syyttr_tau_105_fi.px", "http://pxweb2.stat.fi/database/StatFin/oik/syyttr/054_syyttr_tau_112_fi.px", "http://pxweb2.stat.fi/database/StatFin/oik/syyttr/055_syyttr_tau_106_fi.px", "http://pxweb2.stat.fi/database/StatFin/oik/syyttr/057_syyttr_tau_113_fi.px", "http://pxweb2.stat.fi/database/StatFin/oik/syyttr/058_syyttr_tau_107_fi.px", "http://pxweb2.stat.fi/database/StatFin/oik/syyttr/060_syyttr_tau_103_fi.px", "http://pxweb2.stat.fi/database/StatFin/oik/syyttr/080_syyttr_tau_104_fi.px", "http://pxweb2.stat.fi/database/StatFin/oik/syyttr/080_syyttr_tau_104_fi.px", "http://pxweb2.stat.fi/database/StatFin/oik/syytr/020_syytr_tau_103_fi.px", "http://pxweb2.stat.fi/database/StatFin/oik/syytr/040_syytr_tau_104_fi.px", "http://pxweb2.stat.fi/database/StatFin/oik/syytr/042_syytr_tau_106_fi.px", "http://pxweb2.stat.fi/database/StatFin/oik/syytr/060_syytr_tau_101_fi.px", "http://pxweb2.stat.fi/database/StatFin/oik/syytr/080_syytr_tau_102_fi.px", "http://pxweb2.stat.fi/database/StatFin/rah/hrah/020_hrah_tau_102_fi.px", "http://pxweb2.stat.fi/database/StatFin/rah/llai/020_llai_tau_102_fi.px", "http://pxweb2.stat.fi/database/StatFin/rah/llai/040_llai_tau_104.px", "http://pxweb2.stat.fi/database/StatFin/rah/spy/010_spy_tau_101_fi.px", "http://pxweb2.stat.fi/database/StatFin/rah/spy/040_spy_tau_104_fi.px", "http://pxweb2.stat.fi/database/StatFin/teo/atoi/006_atoi_tau_105_fi.px", "http://pxweb2.stat.fi/database/StatFin/teo/atoi/007_atoi_tau_104_fi.px",  "http://pxweb2.stat.fi/database/StatFin/teo/atoi/010_atoi_tau_101_fi.px", "http://pxweb2.stat.fi/database/StatFin/teo/atoi/020_atoi_tau_102_fi.px", "http://pxweb2.stat.fi/database/StatFin/teo/atoi/025_atoi_tau_109_fi.px", "http://pxweb2.stat.fi/database/StatFin/teo/atoi/030_atoi_tau_103_fi.px", "http://pxweb2.stat.fi/database/StatFin/teo/tti/1998/ht_0105_v1998.px", "http://pxweb2.stat.fi/database/StatFin/teo/tti/1998/ht_1014_v1998.px", "http://pxweb2.stat.fi/database/StatFin/teo/tti/1998/ht_1516_v1998.px", "http://pxweb2.stat.fi/database/StatFin/teo/tti/1998/ht_1719_v1998.px", "http://pxweb2.stat.fi/database/StatFin/teo/tti/1998/ht_2022_v1998.px", "http://pxweb2.stat.fi/database/StatFin/teo/tti/1998/ht_23_v1998.px", "http://pxweb2.stat.fi/database/StatFin/teo/tti/1998/ht_24_v1998.px", "http://pxweb2.stat.fi/database/StatFin/teo/tti/1998/ht_25_v1998.px", "http://pxweb2.stat.fi/database/StatFin/teo/tti/1998/ht_26_v1998.px", "http://pxweb2.stat.fi/database/StatFin/teo/tti/1998/ht_2728_v1998.px", "http://pxweb2.stat.fi/database/StatFin/teo/tti/1998/ht_29_v1998.px", "http://pxweb2.stat.fi/database/StatFin/teo/tti/1998/ht_3033_v1998.px", "http://pxweb2.stat.fi/database/StatFin/teo/tti/1998/ht_3435_v1998.px", "http://pxweb2.stat.fi/database/StatFin/teo/tti/1998/ht_36_v1998.px", "http://pxweb2.stat.fi/database/StatFin/teo/tti/1999/ht_0105_v1999.px", "http://pxweb2.stat.fi/database/StatFin/teo/tti/1999/ht_1014_v1999.px", "http://pxweb2.stat.fi/database/StatFin/teo/tti/1999/ht_1516_v1999.px", "http://pxweb2.stat.fi/database/StatFin/teo/tti/1999/ht_1719_v1999.px", "http://pxweb2.stat.fi/database/StatFin/teo/tti/1999/ht_2022_v1999.px", "http://pxweb2.stat.fi/database/StatFin/teo/tti/1999/ht_23_v1999.px", "http://pxweb2.stat.fi/database/StatFin/teo/tti/1999/ht_24_v1999.px", "http://pxweb2.stat.fi/database/StatFin/teo/tti/1999/ht_25_v1999.px", "http://pxweb2.stat.fi/database/StatFin/teo/tti/1999/ht_26_v1999.px", "http://pxweb2.stat.fi/database/StatFin/teo/tti/1999/ht_2728_v1999.px", "http://pxweb2.stat.fi/database/StatFin/teo/tti/1999/ht_29_v1999.px", "http://pxweb2.stat.fi/database/StatFin/teo/tti/1999/ht_3033_v1999.px", "http://pxweb2.stat.fi/database/StatFin/teo/tti/1999/ht_3435_v1999.px", "http://pxweb2.stat.fi/database/StatFin/teo/tti/1999/ht_36_v1999.px", "http://pxweb2.stat.fi/database/StatFin/teo/tti/1999/tuotanto_salattu_1999.px", "http://pxweb2.stat.fi/database/StatFin/teo/tti/2000/ht_0105_v2000.px", "http://pxweb2.stat.fi/database/StatFin/teo/tti/2000/ht_1014_v2000.px", "http://pxweb2.stat.fi/database/StatFin/teo/tti/2001/ht_0105_v2001.px",  "http://pxweb2.stat.fi/database/StatFin/ter/ksyyt/020_ksyyt_tau_102_fi.px", "http://pxweb2.stat.fi/database/StatFin/ter/ksyyt/030_ksyyt_tau_103_fi.px", "http://pxweb2.stat.fi/database/StatFin/ter/ksyyt/050_ksyyt_tau_105_fi.px", "http://pxweb2.stat.fi/database/StatFin/ttt/tthv/030_tthv_tau_103_fi.px", "http://pxweb2.stat.fi/database/StatFin/ttt/tthv/050_tthv_tau_105_fi.px", "http://pxweb2.stat.fi/database/StatFin/ttt/tthv/051_tthv_tau_105_fi.px", "http://pxweb2.stat.fi/database/StatFin/ttt/tthv/060_tthv_tau_106_fi.px", "http://pxweb2.stat.fi/database/StatFin/ttt/tthv/070_tthv_tau_107_fi.px", "http://pxweb2.stat.fi/database/StatFin/ttt/tthv/080_tthv_tau_108_fi.px", "http://pxweb2.stat.fi/database/StatFin/tul/kbar/010_kbar_tau_101.px", "http://pxweb2.stat.fi/database/StatFin/tym/tyonv/020_tyonv_tau_101_fi.px", "http://pxweb2.stat.fi/database/StatFin/vaa/kvaa/2004_04/040_KVAA_2004_2008-07-17_TAU_101_FI.px", "http://pxweb2.stat.fi/database/StatFin/vaa/kvaa/2004_04/040_KVAA_2004_2008-07-17_TAU_102_FI.px", "http://pxweb2.stat.fi/database/StatFin/vaa/kvaa/2004_04/040_KVAA_2004_2008-07-17_TAU_103_FI.px", "http://pxweb2.stat.fi/database/StatFin/vaa/kvaa/2008_04/410_kvaa_2008_2009-11-02_tau_123_fi.px", "http://pxweb2.stat.fi/database/StatFin/vaa/kvaa/2008_04/420_kvaa_2008_2009-11-02_tau_124_fi.px", "http://pxweb2.stat.fi/database/StatFin/vrm/muutl/020_muutl_tau_102_fi.px", "http://pxweb2.stat.fi/database/StatFin/vrm/muutl/030_muutl_tau_103_fi.px", "http://pxweb2.stat.fi/database/StatFin/vrm/muutl/035_muutl_tau_106.px", "http://pxweb2.stat.fi/database/StatFin/vrm/muutl/040_muutl_tau_104.px", "http://pxweb2.stat.fi/database/StatFin/vrm/muutl/050_muutl_tau_105_fi.px",  "http://pxweb2.stat.fi/database/StatFin/vrm/muutl/055_muutl_tau_107_fi.px", "http://pxweb2.stat.fi/database/StatFin/vrm/perh/020_perh_tau_102_fi.px", "http://pxweb2.stat.fi/database/StatFin/vrm/ssaaty/020_ssaaty_tau_102_fi.px", "http://pxweb2.stat.fi/database/StatFin/vrm/ssaaty/030_ssaaty_tau_103_fi.px", "http://pxweb2.stat.fi/database/StatFin/vrm/tyokay/031_tyokay_tau_109_fi.px", "http://pxweb2.stat.fi/database/StatFin/vrm/tyokay/031_tyokay_tau_113_fi.px", "http://pxweb2.stat.fi/database/StatFin/vrm/vaenn/020_vaenn_tau_102_fi.px", "http://pxweb2.stat.fi/database/StatFin/vrm/vaenn/050_vaenn_tau_105_fi.px", "http://pxweb2.stat.fi/database/StatFin/vrm/vaenn/080_vaenn_tau_108_fi.px", "http://pxweb2.stat.fi/database/StatFin/vrm/vaerak/020_vaerak_tau_101_fi.px", "http://pxweb2.stat.fi/database/StatFin/vrm/vaerak/030_vaerak_tau_102_fi.px", "http://pxweb2.stat.fi/database/StatFin/vrm/vaerak/040_vaerak_tau_103_fi.px", "http://pxweb2.stat.fi/database/StatFin/vrm/vaerak/050_vaerak_tau_104.px", "http://pxweb2.stat.fi/database/StatFin/vrm/vaerak/055_vaerak_tau_124.px", "http://pxweb2.stat.fi/database/StatFin/vrm/vaerak/073_vaerak_tau_109_fi.px", "http://pxweb2.stat.fi/database/StatFin/vrm/vaerak/105_vaerak_tau_116_fi.px", "http://pxweb2.stat.fi/database/StatFin/yri/aly/005_aly_tau_104_fi.px", "http://pxweb2.stat.fi/database/StatFin/yri/aly/010_aly_tau_101_fi.px", "http://pxweb2.stat.fi/database/StatFin/yri/aly/120_aly_tau_102_fi.px", "http://pxweb2.stat.fi/database/StatFin/yri/katipa/009_katipa_tau_102_fi.px", "http://pxweb2.stat.fi/database/StatFin/yri/katipa/010_katipa_tau_101_fi.px", "http://pxweb2.stat.fi/database/StatFin/yri/katipa/katipa_2005_2006-12-15_db_001.px", "http://pxweb2.stat.fi/database/StatFin/yri/patipa/009_patipa_tau_102_fi.px", "http://pxweb2.stat.fi/database/StatFin/yri/patipa/099_patipa_tau_999_fi.px", "http://pxweb2.stat.fi/database/StatFin/yri/litipa/litipa_2005_2006-12-15_db_001.px", "http://pxweb2.stat.fi/database/StatFin/yri/matipa/008_matipa_tau_103_fi.px", "http://pxweb2.stat.fi/database/StatFin/yri/matipa/010_matipa_tau_101_fi.px", "http://pxweb2.stat.fi/database/StatFin/yri/matipa/020_matipa_tau_102_fi.px", "http://pxweb2.stat.fi/database/StatFin/yri/ratipa/008_ratipa_tau_103_fi.px", "http://pxweb2.stat.fi/database/StatFin/yri/ratipa/010_ratipa_tau_101_fi.px", "http://pxweb2.stat.fi/database/StatFin/yri/ratipa/tetipa_2005_2006-12-15_db_002.px", "http://pxweb2.stat.fi/database/StatFin/yri/tetipa/008_tetipa_tau_103_fi.px", "http://pxweb2.stat.fi/database/StatFin/yri/tetipa/009_tetipa_tau_104_fi.px", "http://pxweb2.stat.fi/database/StatFin/yri/tetipa/010_tetipa_tau_105_fi.px", "http://pxweb2.stat.fi/database/StatFin/yri/tetipa/020_tetipa_tau_101_fi.px", "http://pxweb2.stat.fi/database/StatFin/yri/tetipa/050_tetipa_tau_102_fi.px",  "http://pxweb2.stat.fi/database/StatFin/yri/tetipa/tetipa_2005_2006-12-15_db_002.px", "http://pxweb2.stat.fi/database/StatFin/yri/tetipa/tetipa_2005_2006-12-15_db_004.px", "http://pxweb2.stat.fi/database/StatFin/yri/syr/030_muut_tol08/140_syr_tau_114_fi.px")
# somehow skipped 168..173 why?
# i = c(32, 72, 75, 163:167, 219:220, 231) kohdalla jotain ongelmaa
for (i in 1:length(px.tree)) {
  # Loop over the files
  save(i, filesalreadyhandled, file = "tmp.RData")
  for (j in seq(px.tree[[i]])) {
    path <- unlist(strsplit(px.tree[[i]][[j]], split="\\/"))
    l1.folder <- path[6]
    l2.folder <- paste(l1.folder, path[7], sep="/")
    filename <- gsub("\\.px", "\\.csv", path[8])

    if (!filename %in% filesalreadyhandled) {

     # Check whether level 1 folder exists - if not, create it
      if (!file.exists(l1.folder))
        dir.create(l1.folder)
      # Check whether level 2 folder exists - if not, create it
      if (!file.exists(l2.folder))
        dir.create(l2.folder)
      # Write temporary files 
      pxf <- px.tree[[i]][[j]]
      print(c(i, pxf))
      if (!pxf %in% bad.px.files) {
      px <- read.px(pxf) 
      df <- try(as.data.frame(px))

      if (is.data.frame(df)) {
        fn <- unlist(strsplit(pxf, "/")); 
        fn <- strsplit(fn[[length(fn)]], "\\.")[[1]][[1]] 
        #fnam <- paste("csv/", fn, ".csv", sep = "")
        fnam <- paste(l2.folder, filename, sep="/")
        write.table(df, file = fnam, quote = FALSE, sep = "\t", row.names = FALSE)
        #system(paste("gzip", fnam))
        #write("TEMPTEMPTEMP", file=paste(l2.folder, filename, sep="/"))
        filesalreadyhandled <-  c(filesalreadyhandled, filename)
	save(i, filesalreadyhandled, file = "tmp.RData")
      } else {
        pxf.errors <- c(pxf.errors, pxf)
      }
    }
   }
  }
}
save(pxf.errors, file = "pxf.errors.RData")


